---
title: Создание баз данных App-V 4.5 с помощью сценариев SQL
description: Создание баз данных App-V 4.5 с помощью сценариев SQL
author: dansimp
ms.assetid: 6cd0b180-163e-463f-a658-939ab9a7cfa1
ms.reviewer: ''
manager: dansimp
ms.author: dansimp
ms.pagetype: mdop
ms.mktglfcycl: deploy
ms.sitesec: library
ms.prod: w10
ms.date: 06/16/2016
ms.openlocfilehash: c119f1d43a70cce04dd6151697318f7cf6a8d1f2
ms.sourcegitcommit: 3e0500abde44d6a09c7ac8e3caf5e25929b490a4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2021
ms.locfileid: "11910594"
---
# <a name="creating-app-v-45-databases-using-sql-scripting"></a>Создание баз данных App-V 4.5 с помощью сценариев SQL


**Кто предназначено ли это решение?** Специалисты по информационным технологиям, которые управляют базами данных виртуализации приложений (App-V) 4.5.

**Как это руководство может помочь вам?** В этом решении объясняется и документироваться процедура установки сервера виртуализации приложений Майкрософт, когда установка администратора не имеет "sysadmin" привилегий для SQL Server.

## <a name="overview"></a>Обзор


Одна из проблем установки microsoft Application Virtualization 4.5 (App-V) заключается в том, что программа установки предполагает, что пользователь, устанавливающий функции сервера, будет не только локальным администратором компьютера, но и SQL администратором на сервере SQL, на который будет храниться хранилище данных. Это требование основано на том, что база данных, а также соответствующие роли и разрешения создаются в рамках установки. Однако в большинстве предприятий SQL серверы управляются отдельно от группы инфраструктуры, которая будет устанавливать App-V. Эти требования к безопасности затруднит SQL администраторов, чтобы предоставить администратору инфраструктуры, устанавливая соответствующие права App-V; Аналогичным образом администраторы SQL не будут иметь необходимых привилегий для установки продукта для группы инфраструктуры.

В настоящее время администратор, пытающийся установить App-V, должен иметь SQL "sysadmin". В предыдущих версиях продукта установка позволяла администраторам SQL создать временную учетную запись "sysadmin" или присутствовать во время установки, чтобы предоставить учетным данным привилегии "sysadmin". В этом выпуске скрипты предоставляются в выпущенной продукции для всех администраторов, которые будут использовать при реализации своей инфраструктуры.

В этом whitepaper обсуждается сценарий, при котором установка должна быть разделена на две отдельные задачи: создание SQL базы данных и установка функций сервера App-V. Администраторы SQL смогут просмотреть сценарии SQL и внести изменения для разрешения конфликтов с другими базами данных или для поддержки интеграции с другими средствами. В результате скрипты позволяют администраторам SQL подготовить базу данных, чтобы администраторам инфраструктуры не было предоставлено никаких расширенных прав на SQL сервере. Это важно в средах, где политики безопасности запрещают это.

### <a name="sql-database-creation-process"></a>База данных SQL Процесс создания

Скрипты SQL позволяют администраторам SQL создать необходимую базу данных, а также настроить привилегии администраторов App-V для успешной установки и управления средой. Этапы выполнения этих задач перечислены ниже в этом документе.

Этот процесс отделяет действия по созданию базы данных и конфигурации от фактической установки App-V.

**Сведения, которые будут предоставлены SQL администраторам**

-   Имя группы AD, которая будет администратором App-V

-   Имя сервера, на котором будет установлен сервер управления App-V

**Сведения, возвращаемые администраторам инфраструктуры**

-   Имя сервера базы данных или экземпляра и имя базы данных App-V

После подготовки базы данных администраторы App-V могут запускать установку App-V без SQL администратора.

### <a name="using-the-sql-setup-scripts"></a>Использование сценариев SQL установки

**Требования**

Ниже приводится список требований к использованию скриптов, расположенных в папке support\\createdb в корне выбранного расположения экстракта.

-   Скрипты должны быть скопированы в место записи на компьютере, где они будут запущены (обязательно удалите атрибут только для чтения из этих скриптов после их копирования) и SQL клиентские средства должны быть загружены на этот компьютер (osql требуется только для запуска примерных пакетных файлов на локальном компьютере).

-   Этот SQL Server должен поддерживать Windows проверку подлинности.

-   Убедитесь, что SQL Server и службы SQL агентов запущены.

-   Войдите в систему с учетной записью домена, SQL администратором (sysadmin) на компьютере, на котором будут сделаны сценарии.

Скрипты выполняется в соответствии с учетными данными домена пользователя, зарегистрированного в журнале.

**Создание базы данных с SQL скриптами**

**Задачи, выполняемые SQL администраторами:**

1.  Скопируйте скрипты, содержащиеся в папке support\\createdb, из корневого корневого расположения выбранного экстракта на компьютер, на котором будут запускаться сценарии. Для правильного запуска скриптов необходимы следующие файлы, которые должны быть вызваны в порядке, приведеном ниже.

    -   database.sql

    -   roles.sql

    -   table\_CODES.sql

    -   functions\_before\_tables.sql

    -   tables.sql

    -   functions.sql

    -   views.sql

    -   procedures.sql

    -   triggers.sql

    -   data\_codes.sql

    -   data\_messages.sql

    -   data\_defaults.sql

    -   оповещений\_jobs.sql

    -   dbversion.sql

2.  Просмотрите и измените при необходимости `database.sql` файл. Параметры по умолчанию назовут базу данных APPVIRTDB.

    -   При необходимости замените `APPVIRTDB` экземпляры `database name` используемыми экземплярами.

    -   Измените свойство в скрипте с помощью соответствующего пути для SQL Server, где будет `FILENAME` создана база данных.

3.  При необходимости просмотрите и измените файл, используемый `database name [APPVIRTDB]` `roles.sql` в файле database.sql.

****

### <a name="example-of-how-to-automate-the-process-using-batch-files"></a>Пример автоматизации процесса с помощью пакетных файлов

Если используется, два примера пакетных файлов, предоставленных для запуска SQL сценариев следующим образом:

1.  **Create\_schema.bat (1)**

    -   database.sql

    -   roles.sql

2.  **Create\_tables.bat (2)**

    -   table\_CODES.sql

    -   functions\_before\_tables.sql

    -   tables.sql

    -   functions.sql

    -   views.sql

    -   procedures.sql

    -   triggers.sql

    -   data\_codes.sql

    -   data\_messages.sql

    -   data\_defaults.sql

    -   оповещений\_jobs.sql

    -   dbversion.sql

**Примечание.**  
При изменении скриптов необходимо тщательно учитывать, а делать это должен только кто-то, у кого есть соответствующие знания. Кроме того, из представленных примеров файлов следует изменить только следующие: **create\_schema.bat, ** **create\_tables.bat, ** **database.sql**и **roles.sql**. Все остальные файлы не следует изменять, так как это может привести к неправильной работе базы данных, что приведет к сбою установки служб App-V.



Два примера пакетных файлов должны быть размещены в том же каталоге, где остальные SQL были скопированы на компьютере.

1.  Запустите ** примерcreate\_schema.bat** для создания базы данных. Этот сценарий займет несколько секунд и не должен прерываться.

    -   Запустите файл schema.bat из каталога, в который он был скопирован. Синтаксис: `SQLSERVERNAME` "Create\_schema.bat"

        ![AppV46SQLcreatebat.](images/appv46sqlcreatebat.bmp)

    -   Если при создании новой базы данных APPVIRTDB этот сценарий не работает, проверьте журнал, как указано, чтобы устранить проблему. Необходимо удалить базу данных, созданную с частичным запуском скриптов, чтобы обеспечить правильную работу последующих попыток.

2.  Запустите `create_tables.bat` файл, чтобы создать таблицы в базе данных. Этот сценарий займет несколько секунд и не должен прерываться.

    -   Запустите create\_tables.bat из каталога, где он был скопирован. Синтаксис: `SQLSERVERNAME DBNAME` "create\_tables.bat"

        ![app-v 4.6 sql create\-table.bat.](images/appv46sqlcreate-tablebat.gif)

        Если сценарий не работает во время создания таблиц, проверьте журнал, как указано, чтобы устранить проблему. Необходимо удалить базу данных и выполнить create\_schema.bat, прежде чем пытаться запустить файл create\_tables.bat всех последующих попыток.

### <a name="setting-permissions-on-the-app-v-database"></a>Настройка разрешений в базе данных App-V

Следующие учетные записи должны быть созданы на сервере SQL с определенными разрешениями и ролями для новой базы данных для установки, развертывания и постоянного администрирования среды App-V.

-   Создайте вход для группы администраторов App-V в SQL Server и базы данных APPVIRTDB для администраторов домена\\App-V (где будут изменены "домен" и "Администраторы App-V" с учетом вашей среды) и добавьте их в роль базы данных SFTAdmin и SFTEveryone.

    ![app-v 4.6 sql script set permissions and roles.](images/appv46sqlscriptsetpermsroles.gif)

-   Предоставление этой группе разрешений "VIEW ANY DEFINITION" на глобальном уровне (это позволяет процессу установки сервера управления виртуализацией microsoft application для проверки того, что вход на сервер управления уже существует). В ms-SQL 2005 и выше добавлены ограничения доступа к метаданным, содержамся в master.db. Пользователь, созданный на предыдущем шаге, по умолчанию не будет иметь права, необходимые для установки сервера. Откройте свойства ранее созданного входа Login Properties- &gt; Securables. Добавьте экземпляр Базы данных и встройте "GRANT" для "Просмотр любого определения", как показано на скриншоте ниже.

    ![app-v 4.6 sql script grant perm for view any def.](images/appv46sqlscriptviewanydef.gif)

-   Добавьте роль в таблицу ROLE\_ASSIGNMENTS для входа, созданного на предыдущем шаге, чтобы разрешить администраторам App-V доступ к консоли управления виртуализацией приложений, с ролью = "ADMIN" и group\_ref = "domain\\App-V Admins" (где будут изменены "домен" и "Администраторы App-V", чтобы отразить собственную среду).

    ![назначение роли сценария sql app-v 4.6.](images/appv46sqlscriptroleassign.gif)

-   Создание входа для SQL Server и базы данных App-V для сервера управления. Эта учетная запись используется сервером управления виртуализацией приложений Майкрософт для подключения к хранилище данных и отвечает за обслуживание запросов клиентов для потокового использования приложений. Существует два варианта, в зависимости от SQL Server и сервера управления:

    1.  Если сервер управления и SQL Server будут установлены на одном компьютере, добавьте вход для NT AUTHORITY\\NETWORK SERVICE и добавьте его в роли базы данных SFTUser и SFTEveryone.

    2.  Если сервер управления и SQL Server должны быть установлены на разных компьютерах, добавьте журнал для "domain\\App-V Server Name$" (где имя сервера App-V — это имя сервера, на котором будет установлен сервер управления App-V) и добавьте его в роли базы данных SFTUser и SFTEveryone.

-   Откройте окно запроса в окне SQL и запустите следующий SQL:

    ``` syntax
    USE APPVIRTDB
    GRANT ALTER ON ROLE::SFTuser TO “domain\App-V Admins”
    ```

    Если APPVIRTDB — это имя базы данных App-V, созданной на SQL Server на предыдущем шаге, а пользователь, который собирается установить сервер App-v, должен быть членом "domain\\App-V Admins" (где будут изменены "домен" и "Администраторы App-V", чтобы отразить собственную среду).

### <a name="tasks-to-be-performed-by-the-infrastructure-administrators"></a>Задачи, выполняемые администраторами инфраструктуры

1.  Администратор в группе "Администраторы App-V" должен установить App-V.

    Используйте сведения администраторов SQL для выбора SQL Server базы данных, созданной на предыдущих действиях.

2.  Администратор в группе "Администраторы App-V" входит в консоль управления виртуализацией приложений и удаляет следующие объекты из консоли управления.

    **Warning**  
    Это необходимо, так как традиционная настройка заполняет некоторые записи в базе данных, которые не заполнены при запуске установки с уже существующей базой данных. Удаление следующих объектов:

    -   В статье "Группы серверов", "Группа серверов по умолчанию" удалите "Сервер управления виртуализацией приложений"

    -   В статье "Группы серверов" удалите "Группу серверов по умолчанию"

    -   В статье "Политики поставщика" удалите "Поставщик по умолчанию"



3.  Затем администратор в группе администраторов App-V должен создать:

    -   В статье "Политики поставщиков" создайте новую политику поставщика

    -   Создание группы серверов по умолчанию

        **Примечание.**  
        Необходимо создать группу "Сервер по умолчанию", даже если вы не будете использоваться. Установщик сервера ищет только группу серверов по умолчанию при попытке добавить сервер.  Если нет "Группы серверов по умолчанию", установка не будет работать. Если вы планируете использовать группы серверов по умолчанию по умолчанию, необходимо сохранить "Группу серверов по умолчанию", если планируется добавление последующих серверов управления App-V в инфраструктуру.



~~~
-   Assign the App-V Users Group to the New Provider Policy created above

-   Under “Server Groups,” create a New Server Group, specifying the New Provider Policy

-   Under the New Server group, create a New Application Virtualization Management Server

    **Important**  
    Do not restart the service before completing all of the above steps!



-   Administrator restarts the Application Virtualization Management Server service.
~~~

## <a name="conclusion"></a>Заключение


В заключение, сведения в этом документе позволяют администратору работать с SQL администраторами для разработки пути развертывания, который работает для подразделений безопасности и административных подразделений в организации. После прочтения этого документа и проверки задокументированных задач администратор должен быть готов реализовать свою инфраструктуру App-V в этом типе среды.









